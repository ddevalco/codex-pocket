bun test v1.3.8 (b64edcb4)

services/local-orbit/src/providers/__tests__/registry.test.ts:
[ProviderRegistry] Registered provider: test
[ProviderRegistry] Starting all enabled providers...
[ProviderRegistry] Starting provider: test
[ProviderRegistry] Successfully started: test
[ProviderRegistry] Started 1/1 providers
(pass) ProviderRegistry > registers an adapter via factory [0.12ms]
(pass) ProviderRegistry > returns undefined for unknown adapter
[ProviderRegistry] Registered provider: one
[ProviderRegistry] Registered provider: two
(pass) ProviderRegistry > lists all adapter names
[ProviderRegistry] Registered provider: a1
[ProviderRegistry] Registered provider: a2
[ProviderRegistry] Starting all enabled providers...
[ProviderRegistry] Starting provider: a1
[ProviderRegistry] Starting provider: a2
[ProviderRegistry] Successfully started: a1
[ProviderRegistry] Successfully started: a2
[ProviderRegistry] Started 2/2 providers
(pass) ProviderRegistry > starts all enabled adapters
[ProviderRegistry] Registered provider: a1
[ProviderRegistry] Starting all enabled providers...
[ProviderRegistry] Skipping disabled provider: a1
[ProviderRegistry] No enabled providers to start
(pass) ProviderRegistry > skips disabled adapters
[ProviderRegistry] Registered provider: good
[ProviderRegistry] Registered provider: bad
[ProviderRegistry] Starting all enabled providers...
[ProviderRegistry] Starting provider: good
[ProviderRegistry] Starting provider: bad
[ProviderRegistry] Successfully started: good
[ProviderRegistry] Failed to start provider 'bad': 39 |     this.shouldFailStart = opts?.failStart || false;
40 |     this.shouldFailHealth = opts?.failHealth || false;
41 |   }
42 | 
43 |   async start(): Promise<void> {
44 |     if (this.shouldFailStart) throw new Error(`${this.providerId} start failed`);
                                             ^
error: bad start failed
      at start (/Users/danedevalcourt/iPhoneApp/codex-pocket/services/local-orbit/src/providers/__tests__/registry.test.ts:44:41)
      at startProvider (/Users/danedevalcourt/iPhoneApp/codex-pocket/services/local-orbit/src/providers/registry.ts:140:21)
      at startAll (/Users/danedevalcourt/iPhoneApp/codex-pocket/services/local-orbit/src/providers/registry.ts:106:31)
      at <anonymous> (/Users/danedevalcourt/iPhoneApp/codex-pocket/services/local-orbit/src/providers/__tests__/registry.test.ts:154:20)

[ProviderRegistry] Started 1/2 providers
(pass) ProviderRegistry > isolates start errors
[ProviderRegistry] Registered provider: a1
[ProviderRegistry] Registered provider: a2
[ProviderRegistry] Starting all enabled providers...
[ProviderRegistry] Starting provider: a1
[ProviderRegistry] Starting provider: a2
[ProviderRegistry] Successfully started: a1
[ProviderRegistry] Successfully started: a2
[ProviderRegistry] Started 2/2 providers
[ProviderRegistry] Stopping all providers...
[ProviderRegistry] Stopping provider: a1
[ProviderRegistry] Stopping provider: a2
[ProviderRegistry] Successfully stopped: a1
[ProviderRegistry] Successfully stopped: a2
[ProviderRegistry] All providers stopped
(pass) ProviderRegistry > stops all adapters [0.88ms]
[ProviderRegistry] Registered provider: healthy
[ProviderRegistry] Registered provider: unhealthy
[ProviderRegistry] Starting all enabled providers...
[ProviderRegistry] Starting provider: healthy
[ProviderRegistry] Starting provider: unhealthy
[ProviderRegistry] Successfully started: healthy
[ProviderRegistry] Successfully started: unhealthy
[ProviderRegistry] Started 2/2 providers
[ProviderRegistry] Checking health of all providers...
[ProviderRegistry] Provider 'healthy' health: healthy
[ProviderRegistry] Provider 'unhealthy' health: unhealthy
[ProviderRegistry] Health check complete: 1/2 healthy
(pass) ProviderRegistry > aggregates health from all adapters [0.42ms]

services/local-orbit/src/providers/normalizers/__tests__/acp-event-normalizer.test.ts:
(pass) ACPStreamingNormalizer > Basic aggregation > aggregates content deltas into single event [0.25ms]
(pass) ACPStreamingNormalizer > Basic aggregation > handles empty deltas gracefully
(pass) ACPStreamingNormalizer > Basic aggregation > preserves raw notification in rawEvent field
(pass) ACPStreamingNormalizer > Category mapping > maps content to agent_message
(pass) ACPStreamingNormalizer > Category mapping > maps reasoning to reasoning
(pass) ACPStreamingNormalizer > Category mapping > maps tool to tool_command
(pass) ACPStreamingNormalizer > Category mapping > maps status to lifecycle_status
(pass) ACPStreamingNormalizer > Category mapping > maps error to lifecycle_status
(pass) ACPStreamingNormalizer > Type switch flush > flushes context when switching update types
(pass) ACPStreamingNormalizer > Type switch flush > does not flush on type switch if no chunks accumulated
(pass) ACPStreamingNormalizer > Done marker handling > flushes immediately on done marker
(pass) ACPStreamingNormalizer > Done marker handling > flushes immediately on error type
[ACPStreamingNormalizer] Stream timeout for session-1:turn-1 after 1000ms
[ACPStreamingNormalizer] Stream timeout for session-1:turn-1 after 1000ms
(pass) ACPStreamingNormalizer > Timeout handling > flushes incomplete stream after timeout [1003.25ms]
[ACPStreamingNormalizer] Stream timeout for session-1:turn-1 after 500ms
(pass) ACPStreamingNormalizer > Timeout handling > resets timeout on subsequent updates [805.26ms]
(pass) ACPStreamingNormalizer > Concurrent streams > handles multiple concurrent sessions [0.41ms]
(pass) ACPStreamingNormalizer > Concurrent streams > handles multiple concurrent turns in same session [0.36ms]
(pass) ACPStreamingNormalizer > Payload accumulation > accumulates tool execution details [0.06ms]
(pass) ACPStreamingNormalizer > Payload accumulation > accumulates file diff details
(pass) ACPStreamingNormalizer > Event handlers > calls all registered event handlers [0.42ms]
(pass) ACPStreamingNormalizer > Event handlers > can remove event handlers [0.02ms]
[ACPStreamingNormalizer] Event handler error: 682 | 
683 |     it("handles errors in event handlers gracefully", () => {
684 |       let goodHandlerCalled = false;
685 |       const goodHandler = () => { goodHandlerCalled = true; };
686 |       const badHandler = () => {
687 |         throw new Error("Handler error");
                        ^
error: Handler error
      at badHandler (/Users/danedevalcourt/iPhoneApp/codex-pocket/services/local-orbit/src/providers/normalizers/__tests__/acp-event-normalizer.test.ts:687:19)
      at emitEvent (/Users/danedevalcourt/iPhoneApp/codex-pocket/services/local-orbit/src/providers/normalizers/acp-event-normalizer.ts:317:9)
      at flushContext (/Users/danedevalcourt/iPhoneApp/codex-pocket/services/local-orbit/src/providers/normalizers/acp-event-normalizer.ts:248:10)
      at handleUpdate (/Users/danedevalcourt/iPhoneApp/codex-pocket/services/local-orbit/src/providers/normalizers/acp-event-normalizer.ts:164:26)
      at <anonymous> (/Users/danedevalcourt/iPhoneApp/codex-pocket/services/local-orbit/src/providers/normalizers/__tests__/acp-event-normalizer.test.ts:708:63)

(pass) ACPStreamingNormalizer > Event handlers > handles errors in event handlers gracefully [1.01ms]
(pass) ACPStreamingNormalizer > Context management > provides active context count [0.28ms]
(pass) ACPStreamingNormalizer > Context management > clears all contexts [0.12ms]

services/local-orbit/src/providers/normalizers/__tests__/session-normalizer.test.ts:
(pass) ACPSessionNormalizer > normalizes complete ACP session [0.98ms]
(pass) ACPSessionNormalizer > generates title from first message if missing [0.26ms]
(pass) ACPSessionNormalizer > generates preview from messages [0.37ms]
(pass) ACPSessionNormalizer > handles missing timestamps [0.05ms]
(pass) ACPSessionNormalizer > maps status values [20.34ms]
(pass) ACPSessionNormalizer > extracts metadata [1.10ms]
(pass) ACPSessionNormalizer > handles empty session gracefully [0.14ms]
(pass) ACPSessionNormalizer > truncates long titles when generated [0.14ms]
(pass) ACPSessionNormalizer > truncates long previews [0.11ms]

services/local-orbit/src/providers/adapters/__tests__/acp-client.test.ts:
(pass) AcpClient > sends JSON-RPC request and receives response [15.23ms]
(pass) AcpClient > correlates requests and responses by ID [11.40ms]
[acp-client] Timeout: slow/method (id=1) exceeded 100ms (actual: 103ms)
(pass) AcpClient > times out after 5 seconds [103.76ms]
(pass) AcpClient > handles NDJSON line parsing [13.27ms]
(pass) AcpClient > ignores notifications (messages without ID) [52.10ms]
(pass) AcpClient > cleans up pending requests on destroy [1.98ms]
(pass) AcpClient > session routing > routes notifications to session-specific handlers [53.03ms]
(pass) AcpClient > session routing > removes handlers via offSessionEvent [54.08ms]
(pass) AcpClient > session routing > isolates sessions (no cross-session leakage) [53.27ms]
(pass) AcpClient > session routing > cleans up empty handler arrays on offSessionEvent [54.12ms]

services/local-orbit/src/providers/adapters/__tests__/copilot-acp-adapter.test.ts:
[copilot-acp] sendPrompt completed in 0ms (session: copilot-session-xyz)
(pass) CopilotAcpAdapter - sendPrompt > success cases > sends JSON-RPC request with correct structure [2.26ms]
[copilot-acp] sendPrompt completed in 0ms (session: session-123)
(pass) CopilotAcpAdapter - sendPrompt > success cases > returns turnId and status on success
[copilot-acp] sendPrompt completed in 0ms (session: session-123)
(pass) CopilotAcpAdapter - sendPrompt > success cases > defaults status to streaming if not provided [0.03ms]
[copilot-acp] sendPrompt completed in 0ms (session: session-123)
(pass) CopilotAcpAdapter - sendPrompt > success cases > includes attachments when provided [0.31ms]
[copilot-acp] sendPrompt completed in 0ms (session: session-123)
(pass) CopilotAcpAdapter - sendPrompt > success cases > uses default options when not provided [0.12ms]
(pass) CopilotAcpAdapter - sendPrompt > validation errors > throws error for empty sessionId [0.17ms]
(pass) CopilotAcpAdapter - sendPrompt > validation errors > throws error for whitespace-only sessionId [0.06ms]
(pass) CopilotAcpAdapter - sendPrompt > validation errors > throws error for non-string sessionId [0.10ms]
(pass) CopilotAcpAdapter - sendPrompt > validation errors > throws error for empty input text
(pass) CopilotAcpAdapter - sendPrompt > validation errors > throws error for whitespace-only input text [0.11ms]
(pass) CopilotAcpAdapter - sendPrompt > validation errors > throws error for missing input [0.09ms]
(pass) CopilotAcpAdapter - sendPrompt > validation errors > throws error for missing input text
(pass) CopilotAcpAdapter - sendPrompt > validation errors > throws error when client not available [0.25ms]
[copilot-acp] Transient error in sendPrompt (attempt 1/3): Request 1 (sendPrompt) timed out after 5000ms
[copilot-acp] Retrying sendPrompt for session session-123 (attempt 2/3)
[copilot-acp] Transient error in sendPrompt (attempt 2/3): Request 1 (sendPrompt) timed out after 5000ms
[copilot-acp] Retrying sendPrompt for session session-123 (attempt 3/3)
[copilot-acp] sendPrompt failed after 3006ms (attempt 3/3): Request 1 (sendPrompt) timed out after 5000ms
(pass) CopilotAcpAdapter - sendPrompt > timeout handling > times out after 5 seconds [3005.50ms]
[copilot-acp] sendPrompt completed in 0ms (session: session-123)
(pass) CopilotAcpAdapter - sendPrompt > timeout handling > passes 5-second timeout to sendRequest
[copilot-acp] sendPrompt failed after 0ms (attempt 1/3): JSON-RPC error -32600: Invalid Request
(pass) CopilotAcpAdapter - sendPrompt > JSON-RPC error handling > throws structured error on JSON-RPC error
[copilot-acp] Transient error in sendPrompt (attempt 1/3): JSON-RPC error 429: Rate limit exceeded
[copilot-acp] Retrying sendPrompt for session session-123 (attempt 2/3)
[copilot-acp] Transient error in sendPrompt (attempt 2/3): JSON-RPC error 429: Rate limit exceeded
[copilot-acp] Retrying sendPrompt for session session-123 (attempt 3/3)
[copilot-acp] sendPrompt failed after 3003ms (attempt 3/3): JSON-RPC error 429: Rate limit exceeded
(pass) CopilotAcpAdapter - sendPrompt > JSON-RPC error handling > handles rate limit errors [3004.58ms]
[copilot-acp] sendPrompt failed after 0ms (attempt 1/3): JSON-RPC error 404: Session not found
(pass) CopilotAcpAdapter - sendPrompt > JSON-RPC error handling > handles session not found errors
[copilot-acp] sendPrompt failed after 0ms (attempt 1/3): String error
(pass) CopilotAcpAdapter - sendPrompt > JSON-RPC error handling > re-throws non-Error exceptions
[copilot-acp] Transient error in sendPrompt (attempt 1/3): Network unavailable
[copilot-acp] Retrying sendPrompt for session session-retry (attempt 2/3)
[copilot-acp] sendPrompt completed in 1002ms (session: session-retry)
(pass) CopilotAcpAdapter - sendPrompt > error handling and retries > retries on transient failure up to maxRetries [1002.71ms]
[copilot-acp] Transient error in sendPrompt (attempt 1/3): Network unavailable
[copilot-acp] Retrying sendPrompt for session session-fail (attempt 2/3)
[copilot-acp] Transient error in sendPrompt (attempt 2/3): Network unavailable
[copilot-acp] Retrying sendPrompt for session session-fail (attempt 3/3)
[copilot-acp] sendPrompt failed after 3005ms (attempt 3/3): Network unavailable
(pass) CopilotAcpAdapter - sendPrompt > error handling and retries > fails after exhausting maxRetries [3004.07ms]
(pass) CopilotAcpAdapter - sendPrompt > adapter capabilities > reports sendPrompt as supported capability
(pass) CopilotAcpAdapter - sendPrompt > adapter capabilities > maintains other capability flags

 73 pass
 0 fail
 149 expect() calls
Ran 73 tests across 5 files. [12.31s]
