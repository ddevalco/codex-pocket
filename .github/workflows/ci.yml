name: ci

on:
  push:
    branches: [ main ]
  pull_request:

jobs:
  build-and-smoke:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: 'latest'

      - name: Install deps
        run: bun install

      - name: Build UI
        run: bun run build

      - name: Regression guards
        shell: bash
        run: |
          set -euo pipefail
          bun scripts/ci/regression-guards.ts

      - name: Start server (local-orbit)
        shell: bash
        run: |
          set -euo pipefail

          # Provide a config.json so local-orbit doesn't accidentally read a token
          # from a runner's default home dir config (which would break auth in CI).
          cat > /tmp/codex-pocket-ci-config.json <<'JSON'
          { "token": "ci-token" }
          JSON

          export ZANE_LOCAL_TOKEN='ci-token'
          export ZANE_LOCAL_CONFIG_JSON='/tmp/codex-pocket-ci-config.json'
          export ZANE_LOCAL_HOST='127.0.0.1'
          export ZANE_LOCAL_PORT='8790'
          export ZANE_LOCAL_DB='/tmp/codex-pocket-ci.db'
          export ZANE_LOCAL_UI_DIST_DIR='${{ github.workspace }}/dist'
          export ZANE_LOCAL_AUTOSTART_ANCHOR='0'
          export ZANE_LOCAL_UPLOAD_DIR='/tmp/codex-pocket-ci-uploads'
          export ZANE_LOCAL_UPLOAD_RETENTION_DAYS='0'
          export ZANE_LOCAL_PAIR_RATE_LIMIT_MAX='2'
          export ZANE_LOCAL_PAIR_RATE_LIMIT_WINDOW_SEC='120'
          export ZANE_LOCAL_UPLOAD_NEW_RATE_LIMIT_MAX='2'
          export ZANE_LOCAL_UPLOAD_NEW_RATE_LIMIT_WINDOW_SEC='120'

          mkdir -p "$ZANE_LOCAL_UPLOAD_DIR"

          bun run services/local-orbit/src/index.ts > /tmp/codex-pocket-ci.log 2>&1 &
          echo $! > /tmp/codex-pocket-ci.pid

      - name: Wait for /health
        shell: bash
        run: |
          set -euo pipefail

          for i in {1..60}; do
            if curl -fsS "http://127.0.0.1:8790/health" >/tmp/health.json; then
              break
            fi
            sleep 0.25
          done

          # basic sanity: JSON contains status ok
          python3 - <<'PY'
          import json
          d=json.load(open('/tmp/health.json'))
          assert d.get('status')=='ok', d
          assert d.get('port')==8790, d
          print('health ok')
          PY

      - name: Smoke test WebSocket relay
        shell: bash
        run: |
          set -euo pipefail
          CI_BASE_URL="http://127.0.0.1:8790" CI_TOKEN="ci-token" bun scripts/ci/ws-smoke.ts

      - name: Smoke test admin status
        shell: bash
        run: |
          set -euo pipefail

          curl -fsS \
            -H "Authorization: Bearer ci-token" \
            "http://127.0.0.1:8790/admin/status" > /tmp/admin-status.json

          python3 - <<'PY'
          import json
          d=json.load(open('/tmp/admin-status.json'))
          assert d['server']['port']==8790, d
          assert 'uiDistDir' in d, d
          assert 'db' in d, d
          print('admin/status ok')
          PY

      - name: Smoke test admin uploads stats
        shell: bash
        run: |
          set -euo pipefail

          curl -fsS \
            -H "Authorization: Bearer ci-token" \
            "http://127.0.0.1:8790/admin/uploads/stats" > /tmp/admin-uploads-stats.json

          python3 - <<'PY'
          import json
          d=json.load(open('/tmp/admin-uploads-stats.json'))
          assert isinstance(d.get('fileCount'), int), d
          assert isinstance(d.get('totalBytes'), int), d
          assert 'oldestAt' in d, d
          assert 'newestAt' in d, d
          assert 'lastPruneAt' in d, d
          assert 'lastPruneMessage' in d, d
          assert 'lastPruneSource' in d, d
          print('admin/uploads/stats ok')
          PY

      - name: Smoke test admin upload settings update
        shell: bash
        run: |
          set -euo pipefail

          curl -fsS \
            -H "Authorization: Bearer ci-token" \
            -H "Content-Type: application/json" \
            -X POST \
            -d '{"retentionDays":3,"pruneIntervalHours":12}' \
            "http://127.0.0.1:8790/admin/uploads/retention" > /tmp/admin-uploads-retention.json

          python3 - <<'PY'
          import json
          d=json.load(open('/tmp/admin-uploads-retention.json'))
          assert d.get('ok') is True, d
          assert d.get('retentionDays') == 3, d
          assert d.get('pruneIntervalHours') == 12, d
          print('admin/uploads/retention update ok')
          PY

          curl -fsS \
            -H "Authorization: Bearer ci-token" \
            "http://127.0.0.1:8790/admin/status" > /tmp/admin-status-after-uploads-update.json

          python3 - <<'PY'
          import json
          d=json.load(open('/tmp/admin-status-after-uploads-update.json'))
          db=d.get('db') or {}
          assert db.get('uploadRetentionDays') == 3, d
          assert db.get('uploadPruneIntervalHours') == 12, d
          print('admin/status reflects upload settings update')
          PY

      - name: Smoke test admin validate
        shell: bash
        run: |
          set -euo pipefail

          curl -fsS \
            -H "Authorization: Bearer ci-token" \
            "http://127.0.0.1:8790/admin/validate" > /tmp/admin-validate.json

          python3 - <<'PY'
          import json
          d=json.load(open('/tmp/admin-validate.json'))
          assert isinstance(d, dict), d
          assert 'ok' in d, d
          assert isinstance(d['ok'], bool), d
          print('admin/validate ok')
          PY

      - name: Smoke test admin repair (safe actions)
        shell: bash
        run: |
          set -euo pipefail

          curl -fsS \
            -H "Authorization: Bearer ci-token" \
            -H "Content-Type: application/json" \
            -X POST \
            -d '{"actions":["ensureUploadDir","pruneUploads"]}' \
            "http://127.0.0.1:8790/admin/repair" > /tmp/admin-repair-safe.json

          python3 - <<'PY'
          import json
          d=json.load(open('/tmp/admin-repair-safe.json'))
          assert isinstance(d, dict), d
          assert isinstance(d.get('ok'), bool), d
          assert isinstance(d.get('applied'), list), d
          assert isinstance(d.get('errors'), list), d
          assert isinstance(d.get('checks'), list), d
          assert not d['errors'], d
          assert 'ensureUploadDir' in d['applied'], d
          assert 'pruneUploads' in d['applied'], d
          print('admin/repair safe actions ok')
          PY

      - name: Smoke test admin repair (non-Tailscale env)
        shell: bash
        run: |
          set -euo pipefail

          curl -fsS \
            -H "Authorization: Bearer ci-token" \
            -H "Content-Type: application/json" \
            -X POST \
            -d '{"actions":["fixTailscaleServe"]}' \
            "http://127.0.0.1:8790/admin/repair" > /tmp/admin-repair-tailscale.json

          python3 - <<'PY'
          import json
          d=json.load(open('/tmp/admin-repair-tailscale.json'))
          assert isinstance(d, dict), d
          assert isinstance(d.get('ok'), bool), d
          assert isinstance(d.get('applied'), list), d
          assert isinstance(d.get('errors'), list), d
          assert isinstance(d.get('checks'), list), d
          # In CI we typically don't have tailscale; allow either outcome as long as behavior is explicit.
          if 'fixTailscaleServe' not in d['applied']:
            assert len(d['errors']) >= 1, d
          print('admin/repair non-tailscale behavior ok')
          PY

      - name: Smoke test sensitive endpoint rate limits
        shell: bash
        run: |
          set -euo pipefail

          # /admin/pair/new: first two requests should pass, third should be rate-limited.
          for i in 1 2; do
            curl -fsS \
              -H "Authorization: Bearer ci-token" \
              -H "Content-Type: application/json" \
              -X POST \
              -d '{}' \
              "http://127.0.0.1:8790/admin/pair/new" >/tmp/pair-${i}.json
          done
          pair_status=$(curl -sS -o /tmp/pair-3.json -w '%{http_code}' \
            -H "Authorization: Bearer ci-token" \
            -H "Content-Type: application/json" \
            -X POST \
            -d '{}' \
            "http://127.0.0.1:8790/admin/pair/new")
          test "$pair_status" = "429"

          # /uploads/new: first two requests should pass, third should be rate-limited.
          for i in 1 2; do
            curl -fsS \
              -H "Authorization: Bearer ci-token" \
              -H "Content-Type: application/json" \
              -X POST \
              -d '{"filename":"x.png","mime":"image/png","bytes":10}' \
              "http://127.0.0.1:8790/uploads/new" >/tmp/upload-new-${i}.json
          done
          upload_status=$(curl -sS -o /tmp/upload-new-3.json -w '%{http_code}' \
            -H "Authorization: Bearer ci-token" \
            -H "Content-Type: application/json" \
            -X POST \
            -d '{"filename":"x.png","mime":"image/png","bytes":10}' \
            "http://127.0.0.1:8790/uploads/new")
          test "$upload_status" = "429"

      - name: Verify cache headers
        shell: bash
        run: |
          set -euo pipefail

          # SPA routes should serve index.html with no-store to avoid stale bundles after updates.
          curl -fsSI "http://127.0.0.1:8790/app" | tr -d '\r' | grep -i '^cache-control:.*no-store'

          # Hashed assets should be immutable.
          html=$(curl -fsS "http://127.0.0.1:8790/app")

          # Grab the main JS bundle path from the index.html we just fetched.
          # Vite emits double-quoted src attributes.
          js=$(python3 -c "import re,sys; html=sys.stdin.read(); m=re.search(r'src=\"(/assets/[^\"]+\\.js)\"', html); print(m.group(1) if m else '')" <<<"$html")

          if [ -z "$js" ]; then
            echo "ERROR: could not find JS asset path in /app HTML"
            echo "---- html (first 80 lines) ----"
            echo "$html" | sed -n '1,80p'
            exit 1
          fi

          # Cache-Control for hashed assets should include immutable.
          curl -fsSI "http://127.0.0.1:8790${js}" | tr -d '\r' | grep -i '^cache-control:.*immutable'

      - name: Verify /app main bundle loads
        shell: bash
        run: |
          set -euo pipefail

          html=$(curl -fsS "http://127.0.0.1:8790/app")
          js=$(python3 -c "import re,sys; html=sys.stdin.read(); m=re.search(r'src=\\\"(/assets/[^\\\"]+\\.js)\\\"', html); print(m.group(1) if m else '')" <<<"$html")

          if [ -z "$js" ]; then
            echo "ERROR: could not find JS asset path in /app HTML"
            echo "---- html (first 80 lines) ----"
            echo "$html" | sed -n '1,80p'
            exit 1
          fi

          # The main bundle should be fetchable and served as JS.
          curl -fsSI "http://127.0.0.1:8790${js}" | tr -d '\r' | grep -i '^content-type:.*javascript'

      - name: Verify events endpoint
        shell: bash
        run: |
          set -euo pipefail

          # Should return NDJSON (possibly empty) for any thread id.
          # This endpoint is auth-protected.
          curl -fsS \
            -H "Authorization: Bearer ci-token" \
            -o /dev/null \
            -D - \
            "http://127.0.0.1:8790/threads/00000000-0000-0000-0000-000000000000/events" | tr -d '\r' | grep -i '^content-type:.*application/x-ndjson'

      - name: Stop server
        if: always()
        shell: bash
        run: |
          set -euo pipefail
          if [ -f /tmp/codex-pocket-ci.pid ]; then
            kill "$(cat /tmp/codex-pocket-ci.pid)" || true
          fi
          echo "---- server log (tail) ----"
          tail -n 200 /tmp/codex-pocket-ci.log || true
