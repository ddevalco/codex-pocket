# Claude MCP Adapter

Integration with local Claude CLI for on-premise AI usage via Model Context Protocol (MCP).

## Overview

The Claude MCP adapter enables CodeRelay to communicate with the Claude CLI installed locally on your system. Unlike the web-based Claude adapter which uses the Anthropic API, this adapter spawns the `claude` CLI and parses JSON streaming output for real-time responses.

## Features

- ✅ Local Claude CLI integration (no API key required)
- ✅ JSON streaming for real-time responses
- ✅ Local conversation history tracking
- ✅ Process lifecycle management
- ✅ Health monitoring and graceful degradation
- ⚠️ Attachment support (pending CLI capability probe)
- ⚠️ Multi-turn conversations (local history-based)

## Prerequisites

1. **Install Claude CLI** (v2.1.49+):

   ```bash
   # Install Claude CLI from https://docs.anthropic.com/claude/docs/cli
   # Verify installation:
   claude --version
   ```

2. **Verify JSON streaming support**:

   ```bash
   echo "What is 2+2?" | claude --print --output-format=stream-json --verbose
   ```

## Configuration

Add to `~/.coderelay/config.json` (or `~/.codex-pocket/config.json`):

```json
{
  "providers": {
    "claude-mcp": {
      "enabled": true,
      "executablePath": "/Users/yourusername/.local/bin/claude",
      "model": "claude-sonnet-4-6",
      "maxTokens": 8192,
      "promptTimeout": 60000,
      "debug": false
    }
  }
}
```

### Configuration Options

| Field | Type | Default | Description |
|-------|------|---------|-------------|
| `enabled` | boolean | `false` | Enable the adapter (explicit opt-in) |
| `executablePath` | string | (auto-detect) | Full path to `claude` executable |
| `model` | string | `"claude-sonnet-4-6"` | Claude model to use |
| `maxTokens` | number | `8192` | Maximum response tokens |
| `promptTimeout` | number | `60000` | Prompt timeout in milliseconds |
| `debug` | boolean | `false` | Enable debug mode for CLI |

## Architecture

### Process Management

```text
CodeRelay (local-orbit)
  │
  ├─► ClaudeMcpAdapter.start()
  │     └─► findExecutable("claude")
  │     └─► Verify CLI works (--version check)
  │
  ├─► sendPrompt(sessionId, input)
  │     └─► spawnProcess("claude", ["--print", "--output-format=stream-json"])
  │     └─► Write prompt to stdin
  │     └─► Parse JSON stream line-by-line
  │     └─► Emit normalized events
  │
  └─► health()
        └─► Quick version check
        └─► Report status: healthy | degraded | unhealthy
```

### Session Tracking

Since Claude CLI **does not persist sessions server-side**, the adapter tracks conversations locally in memory:

- **Session ID**: Generated by client or provided via `sendPrompt()`
- **History**: Stored in `Map<sessionId, LocalSession>`
- **Multi-turn**: Conversation history prepended to each prompt
- **Persistence**: Sessions lost on adapter restart (use web API adapter for persistence)

### Event Streaming

Claude CLI emits newline-delimited JSON events:

1. **`system/init`** - Session initialization with `session_id`, `model`, tools
2. **`assistant/message`** - Streaming response chunks (delta text)
3. **`rate_limit_event`** - Rate limit status
4. **`result`** - Final completion with token usage and cost

The adapter normalizes these to `NormalizedEvent` format for the UI.

## Usage Examples

### Basic Prompt

```typescript
const adapter = new ClaudeMcpAdapter({ debug: true });
await adapter.start();

// Send prompt
await adapter.sendPrompt("session-123", {
  text: "Explain quantum computing in simple terms",
});

// Subscribe to events
const subscription = await adapter.subscribe("session-123", (event) => {
  console.log("Event:", event.category, event.text);
});

// Later: cleanup
await adapter.unsubscribe(subscription);
await adapter.stop();
```

### Health Monitoring

```typescript
const health = await adapter.health();
// health.status: "healthy" | "degraded" | "unhealthy"
// health.message: Human-readable status
// health.details: { executable, responseTime, consecutiveFailures, ... }
```

### List Sessions

```typescript
const result = await adapter.listSessions();
// result.sessions: NormalizedSession[]
// result.hasMore: boolean
// result.error?: string (if CLI not available)
```

## Comparison: MCP vs Web API

| Feature | Claude MCP (Local CLI) | Claude Web API |
|---------|------------------------|----------------|
| **API Key** | ❌ Not required | ✅ Required |
| **Network** | ❌ No internet needed | ✅ Requires internet |
| **Sessions** | ⚠️ Local only (in-memory) | ✅ Server-side persistence |
| **Streaming** | ✅ JSON streaming | ✅ SSE streaming |
| **Attachments** | ⚠️ TBD (probe CLI) | ✅ Vision API |
| **Cost** | ❌ Uses local credits | ✅ Pay-per-token |
| **Privacy** | ✅ Local execution | ⚠️ Data sent to Anthropic |

## Troubleshooting

### "Claude CLI not found in PATH"

**Solution**: Install Claude CLI or set `executablePath` in config:

```json
{
  "providers": {
    "claude-mcp": {
      "enabled": true,
      "executablePath": "/Users/yourusername/.local/bin/claude"
    }
  }
}
```

### "Health check timeout"

**Cause**: Claude CLI is slow or unresponsive.

**Solutions**:

1. Verify CLI works: `claude --version`
2. Check system resources (CPU, memory)
3. Increase timeout: `"promptTimeout": 120000`

### "Session not found"

**Cause**: Sessions are stored in memory and lost on restart.

**Solution**: Use the web API adapter for persistent sessions, or track session IDs in your client.

## Limitations

1. **No Server-Side Sessions**: Claude CLI doesn't persist conversations. The adapter tracks history locally, which is lost on restart.

2. **No Attachment Support (Yet)**: CLI vision support not yet probed. Attempting to send attachments will log a warning.

3. **No Approval Workflow**: Unlike Copilot ACP, Claude CLI has no interactive approval mechanism.

4. **Single-Process**: Each prompt spawns a new `claude` process. For high-volume use cases, consider the web API adapter.

## Future Enhancements

- [ ] Probe CLI for vision/attachment support
- [ ] Implement `claude mcp serve` mode for persistent process
- [ ] Add conversation history persistence (SQLite)
- [ ] Support MCP server configuration
- [ ] Implement tool/function calling if CLI exposes it

## References

- [Claude CLI Documentation](https://docs.anthropic.com/claude/docs/cli)
- [Model Context Protocol (MCP)](https://modelcontextprotocol.io/)
- [CodeRelay Provider Architecture](../providers/README.md)
- [Copilot ACP Adapter](./copilot-acp-adapter.ts) (reference implementation)

## Support

For issues or questions:

- GitHub Issues: <https://github.com/ddevalco/CodeRelay/issues>
- Provider health: Check Admin → Status for real-time diagnostics
